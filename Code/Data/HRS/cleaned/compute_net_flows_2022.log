-------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS/cleaned
> /compute_net_flows_2022.log
  log type:  text
 opened on:  21 Aug 2025, 16:33:01

. 
. set more off

. 
. local master "/Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS/clea
> ned/hrs_2020_2022_master.dta"

. capture confirm file "`master'"

. if _rc {
.     di as error "ERROR: master file not found -> `master'"
.     exit 198
. }

. 
. use "`master'", clear

. di as txt "Using master file: `master'"
Using master file: /Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS/c
> leaned/hrs_2020_2022_master.dta

. 
. * ---------------------------------------------------------------------
. * Optional: convert common special codes to Stata missing (numeric variables)
. * ---------------------------------------------------------------------
. local misscodes 999999998 999999999 -8 -9

. foreach v of varlist _all {
  2.     capture confirm numeric variable `v'
  3.     if !_rc {
  4.         foreach mc of local misscodes {
  5.             quietly replace `v' = . if `v' == `mc'
  6.         }
  7.     }
  8. }

. 
. * ---------------------------------------------------------------------
. * Variables (2022)
. * - private business: SR050 (invest), SR055 (sell)
. * - stocks (private): SR063 (direction), SR064 (magnitude)
. *   - public stocks (sold only): SR073 (sold)
. * - real estate: SR030 (buy), SR035 (sold), SR045 (improvement costs)
. * - IRA: SQ171_1, SQ171_2, SQ171_3
. * - primary/secondary residence(s): SR007 (buy), SR013 (sell), SR024 (improvement c
> osts)
. * ---------------------------------------------------------------------
. 
. local vars_to_check "SR050 SR055 SR063 SR064 SR073 SR030 SR035 SR045 SQ171_1 SQ171_
> 2 SQ171_3 SR007 SR013 SR024"

. di as txt "Checking existence of required 2022 variables..."
Checking existence of required 2022 variables...

. foreach v of local vars_to_check {
  2.     capture confirm variable `v'
  3.     if _rc {
  4.         di as err "  WARNING: variable `v' not found in master dataset"
  5.     }
  6.     else {
  7.         di as txt "  OK: `v' present"
  8.     }
  9. }
  OK: SR050 present
  OK: SR055 present
  OK: SR063 present
  OK: SR064 present
  OK: SR073 present
  OK: SR030 present
  OK: SR035 present
  OK: SR045 present
  OK: SQ171_1 present
  OK: SQ171_2 present
  OK: SQ171_3 present
  OK: SR007 present
  OK: SR013 present
  OK: SR024 present

. 
. * ---------------------------------------------------------------------
. * Clean SR063: convert codes 8 and 9 -> missing; convert 3 -> 0
. * Then map direction: 1 -> -1 (put money in), 2 -> +1 (take money out), 3 -> 0
. * ---------------------------------------------------------------------
. capture confirm variable SR063

. if _rc {
.     di as txt "SR063 not found; skipping SR063 cleaning/mapping."
. }

. else {
.     di as txt "Cleaning SR063 (private stock net buyer/seller)..."
Cleaning SR063 (private stock net buyer/seller)...
.     quietly replace SR063 = . if inlist(SR063,8,9)
.     quietly replace SR063 = 0 if SR063 == 3
.     capture drop sr063_dir
.     gen byte sr063_dir = . 
(14,276 missing values generated)
.     replace sr063_dir = -1 if SR063 == 1
(79 real changes made)
.     replace sr063_dir =  1 if SR063 == 2
(69 real changes made)
.     replace sr063_dir =  0 if SR063 == 3
(0 real changes made)
.     di as txt "SR063 mapping summary (post-clean):"
SR063 mapping summary (post-clean):
.     tab SR063, missing

  R PUT NEW |
  AMT IN OR |
   TAKE OUT |
     STOCKS |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        107        0.75        0.75
          1 |         79        0.55        1.30
          2 |         69        0.48        1.79
          . |     14,021       98.21      100.00
------------+-----------------------------------
      Total |     14,276      100.00
.     di as txt "sr063_dir summary:"
sr063_dir summary:
.     tab sr063_dir, missing

  sr063_dir |      Freq.     Percent        Cum.
------------+-----------------------------------
         -1 |         79        0.55        0.55
          1 |         69        0.48        1.04
          . |     14,128       98.96      100.00
------------+-----------------------------------
      Total |     14,276      100.00
. }

. 
. * ---------------------------------------------------------------------
. * Compute net flows per asset class (2022)
. * ---------------------------------------------------------------------
. * --- Private business: SR055 (sell/inflow) minus SR050 (invest/outflow)
. capture confirm variable SR055

. if _rc {
.     di as txt "SR055 missing -> setting flow_bus_2022 to missing"
.     gen double flow_bus_2022 = .
. }

. else {
.     capture confirm variable SR050
.     if _rc {
.         di as txt "SR050 missing; using SR055 only for flow_bus_2022"
.         gen double flow_bus_2022 = SR055
.     }
.     else {
.         gen double flow_bus_2022 = . 
(14,276 missing values generated)
.         replace flow_bus_2022 = SR055 - SR050 if !missing(SR055) | !missing(SR050)
(3 real changes made)
.     }
.     di as txt "Private business flow summary:"
Private business flow summary:
.     summarize flow_bus_2022, detail

                        flow_bus_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%       -55000         -55000
 5%       -55000              0
10%       -55000        2750000       Obs                   3
25%       -55000              .       Sum of wgt.           3

50%            0                      Mean           898333.3
                        Largest       Std. dev.       1603826
75%      2750000              .
90%      2750000         -55000       Variance       2.57e+12
95%      2750000              0       Skewness       .7061714
99%      2750000        2750000       Kurtosis            1.5
. }

. 
. * --- Private stocks: sr063_dir * SR064
. capture confirm variable SR064

. if _rc {
.     di as txt "SR064 (stock magnitude) missing -> setting flow_stk_private_2022 to 
> missing"
.     gen double flow_stk_private_2022 = .
. }

. else {
.     gen double flow_stk_private_2022 = .
(14,276 missing values generated)
.     replace flow_stk_private_2022 = sr063_dir * SR064 if !missing(sr063_dir) & !mis
> sing(SR064)
(116 real changes made)
.     di as txt "Private stock flow summary (sr063_dir * SR064):"
Private stock flow summary (sr063_dir * SR064):
.     summarize flow_stk_private_2022, detail

                    flow_stk_private_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -300000       -2000000
 5%      -200000        -300000
10%      -100000        -300000       Obs                 116
25%       -20000        -250000       Sum of wgt.         116

50%          -50                      Mean           10070.69
                        Largest       Std. dev.      266721.3
75%        40400         300000
90%       100000         500000       Variance       7.11e+10
95%       250000         600000       Skewness      -1.752954
99%       600000        1600000       Kurtosis       39.77505
. }

. 
. * --- Public stocks: SR073 is reported as sold amount (inflow). Keep positive.
. capture confirm variable SR073

. if _rc {
.     di as txt "SR073 not found -> flow_stk_public_2022 missing"
.     gen double flow_stk_public_2022 = .
. }

. else {
.     gen double flow_stk_public_2022 = SR073
(14,114 missing values generated)
.     di as txt "Public stock (sold) flow summary (SR073):"
Public stock (sold) flow summary (SR073):
.     summarize flow_stk_public_2022, detail

                    flow_stk_public_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%          500              0
10%         2000              0       Obs                 162
25%         8000              0       Sum of wgt.         162

50%        24000                      Mean           69615.31
                        Largest       Std. dev.      131052.2
75%        75000         600000
90%       200000         600000       Variance       1.72e+10
95%       300000         730000       Skewness       4.125808
99%       730000        1000000       Kurtosis        23.8836
. }

. 
. * Combine private + public stocks into total stocks flow (public component is added
> )
. capture drop flow_stk_2022

. egen double flow_stk_2022 = rowtotal(flow_stk_private_2022 flow_stk_public_2022)

. di as txt "TOTAL stocks flow (2022) summary:"
TOTAL stocks flow (2022) summary:

. summarize flow_stk_2022, detail

                        flow_stk_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0       -2000000
 5%            0        -300000
10%            0        -300000       Obs              14,276
25%            0        -250000       Sum of wgt.      14,276

50%            0                      Mean           871.8045
                        Largest       Std. dev.      28668.36
75%            0         600000
90%            0         730000       Variance       8.22e+08
95%            0        1000000       Skewness      -4.368764
99%        13000        1600000       Kurtosis       2534.067

. 
. * --- Real estate: SR035 (sold, inflow) - SR030 (buy, outflow) - SR045 (improvement
>  costs, outflow)
. gen double flow_re_2022 = .
(14,276 missing values generated)

. replace flow_re_2022 = cond(missing(SR035),0,SR035) - ( cond(missing(SR030),0,SR030
> ) + cond(missing(SR045),0,SR045) ) ///
>     if !missing(SR035) | !missing(SR030) | !missing(SR045)
(267 real changes made)

. di as txt "Real estate flow summary:"
Real estate flow summary:

. summarize flow_re_2022, detail

                        flow_re_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%     -1200000       -6400000
 5%      -515000       -1500000
10%      -290000       -1200000       Obs                 267
25%       -65000       -1040000       Sum of wgt.         267

50%       -10000                      Mean           3581.925
                        Largest       Std. dev.      575811.8
75%        85000        1700000
90%       240000        1750000       Variance       3.32e+11
95%       550000        2170000       Skewness      -3.958525
99%      1750000        3500000       Kurtosis       64.95414

. 
. * --- IRA: sum SQ171_1 SQ171_2 SQ171_3 (kept as reported)
. egen double flow_ira_2022 = rowtotal(SQ171_1 SQ171_2 SQ171_3)

. di as txt "IRA flow summary (row-sum of SQ171_1/2/3):"
IRA flow summary (row-sum of SQ171_1/2/3):

. summarize flow_ira_2022, detail

                        flow_ira_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%            0              0       Obs              14,276
25%            0              0       Sum of wgt.      14,276

50%            0                      Mean           3041.214
                        Largest       Std. dev.      22244.62
75%            0         500000
90%            0         700000       Variance       4.95e+08
95%        10000         895000       Skewness       20.92249
99%        80000        1060000       Kurtosis       703.3674

. tabstat flow_ira_2022, stats(n mean sd p50 min max) format(%12.2f)

    Variable |            N         Mean           SD          p50          Min
-------------+-----------------------------------------------------------------
flow_ir~2022 |     14276.00      3041.21     22244.62         0.00         0.00
-------------------------------------------------------------------------------

    Variable |          Max
-------------+-------------
flow_ir~2022 |   1060000.00
---------------------------

. 
. * --- Primary/secondary residence(s): SR013 (sell, inflow) - SR007 (buy, outflow) -
>  SR024 (improvements, outflow)
. gen double flow_residences_2022 = .
(14,276 missing values generated)

. replace flow_residences_2022 = cond(missing(SR013),0,SR013) - ( cond(missing(SR007)
> ,0,SR007) + cond(missing(SR024),0,SR024) ) ///
>     if !missing(SR013) | !missing(SR007) | !missing(SR024)
(1,679 real changes made)

. di as txt "Primary/secondary residences flow summary:"
Primary/secondary residences flow summary:

. summarize flow_residences_2022, detail

                    flow_residences_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -600000       -2660000
 5%      -250000       -2050000
10%      -130000       -1600000       Obs               1,679
25%       -40000       -1003000       Sum of wgt.       1,679

50%       -15000                      Mean          -6364.941
                        Largest       Std. dev.      223191.9
75%        -3000        1100000
90%       147000        1225000       Variance       4.98e+10
95%       312000        2000000       Skewness       1.577617
99%       735000        3500000       Kurtosis       63.37749

. 
. * ---------------------------------------------------------------------
. * Total net investment flows (2022): sum over asset classes
. * IRA flows negated in the overall total (treat as household outflows)
. * ---------------------------------------------------------------------
. capture drop flow_ira_2022_neg

. gen double flow_ira_2022_neg = -flow_ira_2022

. 
. egen double flow_total_2022 = rowtotal(flow_bus_2022 flow_stk_2022 flow_re_2022 flo
> w_ira_2022_neg flow_residences_2022)

. di as txt "TOTAL net investment flows 2022 summary (sum across asset classes; IRA n
> egated):"
TOTAL net investment flows 2022 summary (sum across asset classes; IRA negated):

. summarize flow_total_2022, detail

                       flow_total_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -229000       -6400000
 5%       -40000       -2660000
10%       -12000       -2250000       Obs              14,276
25%            0       -2050000       Sum of wgt.      14,276

50%            0                      Mean           -2662.22
                        Largest       Std. dev.      114537.5
75%            0        2550000
90%            0        2837500       Variance       1.31e+10
95%            0        3406000       Skewness      -7.478784
99%       245000        3500000       Kurtosis       908.9123

. tabstat flow_total_2022, stats(n mean sd p50 min max) format(%12.2f)

    Variable |            N         Mean           SD          p50          Min
-------------+-----------------------------------------------------------------
flow_to~2022 |     14276.00     -2662.22    114537.51         0.00  -6400000.00
-------------------------------------------------------------------------------

    Variable |          Max
-------------+-------------
flow_to~2022 |   3500000.00
---------------------------

. 
. * ---------------------------------------------------------------------
. * Diagnostics...
. * ---------------------------------------------------------------------
. di as txt "=== Diagnostics: SR063 direction missing but SR064 magnitude present ===
> "
=== Diagnostics: SR063 direction missing but SR064 magnitude present ===

. capture confirm variable SR064

. if _rc == 0 {
.     quietly count if missing(sr063_dir) & !missing(SR064)
.     di as txt "Records with SR064 present but sr063_dir missing = " r(N)
Records with SR064 present but sr063_dir missing = 0
.     quietly list HHID RSUBHH SR063 sr063_dir SR064 flow_stk_private_2022 in 1/20 if
>  missing(sr063_dir) & !missing(SR064)
. }

. 
. di as txt "=== Diagnostics: magnitude present for sells/buys but computed flow miss
> ing ==="
=== Diagnostics: magnitude present for sells/buys but computed flow missing ===

. foreach pair in "SR055 SR050 flow_bus_2022" "SR035 SR030 flow_re_2022" "SR013 SR007
>  flow_residences_2022" "SR073 SR073 flow_stk_public_2022" {
  2.     local sell : word 1 of `pair'
  3.     local buy  : word 2 of `pair'
  4.     local outv : word 3 of `pair'
  5.     di as txt "---- Checking `outv' (sell `sell' ; buy `buy')"
  6.     quietly count if ( (!missing(`sell') | !missing(`buy')) & missing(`outv') )
  7.     di as txt "Records with sell/buy present but `outv' missing = " r(N)
  8.     quietly list HHID RSUBHH `sell' `buy' `outv' in 1/20 if ( (!missing(`sell') 
> | !missing(`buy')) & missing(`outv') )
  9. }
---- Checking flow_bus_2022 (sell SR055 ; buy SR050)
Records with sell/buy present but flow_bus_2022 missing = 96
---- Checking flow_re_2022 (sell SR035 ; buy SR030)
Records with sell/buy present but flow_re_2022 missing = 0
---- Checking flow_residences_2022 (sell SR013 ; buy SR007)
Records with sell/buy present but flow_residences_2022 missing = 0
---- Checking flow_stk_public_2022 (sell SR073 ; buy SR073)
Records with sell/buy present but flow_stk_public_2022 missing = 0

. 
. * ---------------------------------------------------------------------
. * Save dataset with new computed net flows BACK TO MASTER (overwrite)
. * ---------------------------------------------------------------------
. save "`master'", replace
file /Volumes/SSD
    PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS/cleaned/hrs_2020_2022_maste
    > r.dta saved

. di as txt "Saved 2022 net-flow vars back to master: `master'"
Saved 2022 net-flow vars back to master: /Volumes/SSD PRO/Github-forks/Chp2-Beliefsan
> dTrust/Code/Data/HRS/cleaned/hrs_2020_2022_master.dta

. 
. log close
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS/cleaned
> /compute_net_flows_2022.log
  log type:  text
 closed on:  21 Aug 2025, 16:33:01
-------------------------------------------------------------------------------------
