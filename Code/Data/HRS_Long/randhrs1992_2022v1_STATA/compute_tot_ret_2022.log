--------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_Long/randhrs19
> 92_2022v1_STATA/compute_tot_ret_2022.log
  log type:  text
 opened on:   8 Oct 2025, 12:08:28

. 
. set more off

. 
. * ---------------------------------------------------------------------
. * File paths
. * ---------------------------------------------------------------------
. local input_file "/Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_Long/ra
> ndhrs1992_2022v1_STATA/_randhrs1992_2022v1_analysis.dta"

. local output_file "/Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_Long/r
> andhrs1992_2022v1_STATA/_randhrs1992_2022v1_analysis.dta"

. 
. * ---------------------------------------------------------------------
. * Load data
. * ---------------------------------------------------------------------
. di as txt "=== Loading merged longitudinal file ==="
=== Loading merged longitudinal file ===

. 
. capture confirm file "`input_file'"

. if _rc {
.     di as error "ERROR: Input file not found -> `input_file'"
.     di as error "Please run long_merge_in.do first"
.     exit 198
. }

. 
. use "`input_file'", clear

. 
. di as txt "File loaded successfully"
File loaded successfully

. quietly describe

. local n_vars = r(k)

. local n_obs = r(N)

. di as txt "Variables: `n_vars', Observations: `n_obs'"
Variables: 19911, Observations: 15856

. 
. * ---------------------------------------------------------------------
. * Clean missing value codes
. * ---------------------------------------------------------------------
. di as txt "=== Cleaning missing value codes ==="
=== Cleaning missing value codes ===

. 
. local misscodes 999999998 999999999 -8 -9

. foreach v of varlist _all {
  2.     capture confirm numeric variable `v'
  3.     if !_rc {
  4.         foreach mc of local misscodes {
  5.             quietly replace `v' = . if `v' == `mc'
  6.         }
  7.     }
  8. }

. 
. * ---------------------------------------------------------------------
. * Step 1: Check for imported flow_total_2022 variable
. * ---------------------------------------------------------------------
. di as txt "=== Checking for imported flow_total_2022 variable ==="
=== Checking for imported flow_total_2022 variable ===

. 
. capture confirm variable flow_total_2022

. if _rc {
.     di as error "ERROR: flow_total_2022 not found - this should have been imported by long
> _merge_in.do"
.     exit 198
. }

. 
. di as txt "flow_total_2022 found - using imported flows from HRS_RAND data"
flow_total_2022 found - using imported flows from HRS_RAND data

. di as txt "Total net investment flows (flow_total_2022) summary:"
Total net investment flows (flow_total_2022) summary:

. summarize flow_total_2022, detail

                       flow_total_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -611000       -6400000
 5%      -205000       -6400000
10%       -85000       -2660000       Obs               4,249
25%       -20000       -2660000       Sum of wgt.       4,249

50%          720                      Mean           13893.93
                        Largest       Std. dev.      281210.5
75%        28500        3450000
90%       140000        3474000       Variance       7.91e+10
95%       290000        3474000       Skewness      -3.239746
99%       785000        3500000       Kurtosis       168.9372

. 
. * Note: We will not create "safe" copies; we'll build numerators/denominators inline
. 
. * ---------------------------------------------------------------------
. * Step 2: Beginning net worth (A_{2020})
. * ---------------------------------------------------------------------
. di as txt "=== Computing beginning net worth (A_2020) ==="
=== Computing beginning net worth (A_2020) ===

. 
. * Use H15ATOTB (Total of all assets net of debt, Wave 15 = 2020)
. capture confirm variable h15atotb

. if _rc {
.     di as error "ERROR: h15atotb not found - this is required for beginning net worth"
.     exit 198
. }

. 
. gen double a_2020 = h15atotb
(3,688 missing values generated)

. di as txt "Beginning net worth (A_2020) summary:"
Beginning net worth (A_2020) summary:

. summarize a_2020, detail

                           a_2020
-------------------------------------------------------------
      Percentiles      Smallest
 1%       -32800       -2442000
 5%        -1500        -999400
10%            0      -404128.2       Obs              12,168
25%        23500      -379210.8       Sum of wgt.      12,168

50%       187000                      Mean           573864.8
                        Largest       Std. dev.       1238477
75%       594000       2.65e+07
90%      1437072       2.65e+07       Variance       1.53e+12
95%      2399000       2.74e+07       Skewness       7.136759
99%      5853500       2.74e+07       Kurtosis       97.03008

. quietly count if !missing(a_2020)

. di as txt "Non-missing A_2020: " r(N)
Non-missing A_2020: 12168

. 
. * ---------------------------------------------------------------------
. * Step 3: Capital income (y^c_t)
. * ---------------------------------------------------------------------
. di as txt "=== Computing capital income (y^c_t) ==="
=== Computing capital income (y^c_t) ===

. 
. * Use H16ICAP (Household capital income, Wave 16 = 2022)
. capture confirm variable h16icap

. if _rc {
.     di as error "ERROR: h16icap not found - this is required for capital income"
.     exit 198
. }

. 
. gen double y_c_2022 = h16icap

. di as txt "Capital income (y_c_2022) summary:"
Capital income (y_c_2022) summary:

. summarize y_c_2022, detail

                          y_c_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%            0              0       Obs              15,856
25%            0              0       Sum of wgt.      15,856

50%            0                      Mean           14980.72
                        Largest       Std. dev.      74438.66
75%         2400        1360000
90%        31320        1800012       Variance       5.54e+09
95%        78060        4089364       Skewness       25.82487
99%       255050        4089364       Kurtosis       1202.849

. 
. * We'll use y_c_2022 directly in inline expressions below
. 
. * ---------------------------------------------------------------------
. * Step 4: Compute capital gains by asset class (V_2022 - V_2020)
. * ---------------------------------------------------------------------
. di as txt "=== Computing capital gains by asset class ==="
=== Computing capital gains by asset class ===

. 
. * Primary residence (net)
. capture confirm variable h16atoth h15atoth

. if _rc {
.     di as txt "WARNING: Primary residence variables (h16atoth, h15atoth) not found"
.     gen double cg_res_2022 = .
. }

. else {
.     gen double cg_res_2022 = h16atoth - h15atoth
(3,688 missing values generated)
.     di as txt "Primary residence capital gains summary:"
Primary residence capital gains summary:
.     summarize cg_res_2022, detail

                         cg_res_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -322000       -3300000
 5%      -100000       -2700000
10%       -30000       -2200000       Obs              12,168
25%            0       -2200000       Sum of wgt.      12,168

50%        10000                      Mean           54718.53
                        Largest       Std. dev.      175725.3
75%        92000        2000000
90%       200000        2500000       Variance       3.09e+10
95%       300000        2700000       Skewness       1.998127
99%       663631        4464487       Kurtosis        77.6864
. }

. 
. * Secondary residence (net)
. capture confirm variable h16anethb h15anethb

. if _rc {
.     di as txt "WARNING: Secondary residence variables (h16anethb, h15anethb) not found"
.     gen double cg_res2_2022 = .
. }

. else {
.     gen double cg_res2_2022 = h16anethb - h15anethb
(3,688 missing values generated)
.     di as txt "Secondary residence capital gains summary:"
Secondary residence capital gains summary:
.     summarize cg_res2_2022, detail

                        cg_res2_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -300000       -2550000
 5%       -20000       -1600000
10%            0       -1600000       Obs              12,168
25%            0       -1500000       Sum of wgt.      12,168

50%            0                      Mean           4731.702
                        Largest       Std. dev.      129958.3
75%            0        2687000
90%            0        2800000       Variance       1.69e+10
95%        51000        2800000       Skewness       6.848787
99%       400000        4800000       Kurtosis       259.6893
. }

. 
. * Other real estate
. capture confirm variable h16arles h15arles

. if _rc {
.     di as txt "WARNING: Other real estate variables (h16arles, h15arles) not found"
.     gen double cg_re_2022 = .
. }

. else {
.     gen double cg_re_2022 = h16arles - h15arles
(3,688 missing values generated)
.     di as txt "Other real estate capital gains summary:"
Other real estate capital gains summary:
.     summarize cg_re_2022, detail

                         cg_re_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -600000       -9000000
 5%       -40000       -7000000
10%            0       -7000000       Obs              12,168
25%            0       -7000000       Sum of wgt.      12,168

50%            0                      Mean           7355.592
                        Largest       Std. dev.      336412.7
75%            0        7000000
90%            0        7800000       Variance       1.13e+11
95%       100000       1.08e+07       Skewness       5.617334
99%       700000       1.08e+07       Kurtosis       386.2045
. }

. 
. * Private business
. capture confirm variable h16absns h15absns

. if _rc {
.     di as txt "WARNING: Private business variables (h16absns, h15absns) not found"
.     gen double cg_bus_2022 = .
. }

. else {
.     gen double cg_bus_2022 = h16absns - h15absns
(3,688 missing values generated)
.     di as txt "Private business capital gains summary:"
Private business capital gains summary:
.     summarize cg_bus_2022, detail

                         cg_bus_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -300000       -7994000
 5%            0       -7994000
10%            0       -6300000       Obs              12,168
25%            0       -3500000       Sum of wgt.      12,168

50%            0                      Mean           9980.116
                        Largest       Std. dev.      291907.6
75%            0        5000000
90%            0        8255182       Variance       8.52e+10
95%            0        8255182       Skewness       9.656212
99%       600000       1.30e+07       Kurtosis       592.2097
. }

. 
. * IRA / Keogh
. capture confirm variable h16aira h15aira

. if _rc {
.     di as txt "WARNING: IRA/Keogh variables (h16aira, h15aira) not found"
.     gen double cg_ira_2022 = .
. }

. else {
.     gen double cg_ira_2022 = h16aira - h15aira
(3,688 missing values generated)
.     di as txt "IRA/Keogh capital gains summary:"
IRA/Keogh capital gains summary:
.     summarize cg_ira_2022, detail

                         cg_ira_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%    -478756.2       -2196217
 5%       -95000       -2196217
10%       -25000       -2176354       Obs              12,168
25%            0       -2176354       Sum of wgt.      12,168

50%            0                      Mean           25744.14
                        Largest       Std. dev.      229334.7
75%            0        2800000
90%       100000        3399824       Variance       5.26e+10
95%       270000        3980000       Skewness       9.128092
99%     934229.2        9779851       Kurtosis       309.5037
. }

. 
. * Stocks / mutual funds
. capture confirm variable h16astck h15astck

. if _rc {
.     di as txt "WARNING: Stock variables (h16astck, h15astck) not found"
.     gen double cg_stk_2022 = .
. }

. else {
.     gen double cg_stk_2022 = h16astck - h15astck
(3,688 missing values generated)
.     di as txt "Stock capital gains summary:"
Stock capital gains summary:
.     summarize cg_stk_2022, detail

                         cg_stk_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -625000       -7000000
 5%       -63000       -7000000
10%        -1000       -7000000       Obs              12,168
25%            0       -5361791       Sum of wgt.      12,168

50%            0                      Mean            9332.86
                        Largest       Std. dev.        319365
75%            0        4000000
90%        15000        6424489       Variance       1.02e+11
95%       130000        7583000       Skewness       .2846811
99%       800000        7583000       Kurtosis       180.0707
. }

. 
. * Bonds
. capture confirm variable h16abond h15abond

. if _rc {
.     di as txt "WARNING: Bond variables (h16abond, h15abond) not found"
.     gen double cg_bnd_2022 = .
. }

. else {
.     gen double cg_bnd_2022 = h16abond - h15abond
(3,688 missing values generated)
.     di as txt "Bond capital gains summary:"
Bond capital gains summary:
.     summarize cg_bnd_2022, detail

                         cg_bnd_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -102253       -2200000
 5%            0       -2130000
10%            0       -2064853       Obs              12,168
25%            0       -1798591       Sum of wgt.      12,168

50%            0                      Mean          -292.1479
                        Largest       Std. dev.      78079.76
75%            0        1574468
90%            0        1614436       Variance       6.10e+09
95%            0        2000000       Skewness      -.9652946
99%       100000        2000000       Kurtosis       326.0922
. }

. 
. * Checking / savings / money market
. capture confirm variable h16achck h15achck

. if _rc {
.     di as txt "WARNING: Checking/savings variables (h16achck, h15achck) not found"
.     gen double cg_chk_2022 = .
. }

. else {
.     gen double cg_chk_2022 = h16achck - h15achck
(3,688 missing values generated)
.     di as txt "Checking/savings capital gains summary:"
Checking/savings capital gains summary:
.     summarize cg_chk_2022, detail

                         cg_chk_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -210000       -4973000
 5%       -50000       -2360000
10%       -20000       -2360000       Obs              12,168
25%        -2000       -2000000       Sum of wgt.      12,168

50%            0                      Mean           8988.859
                        Largest       Std. dev.      114023.6
75%         9000        1935000
90%        50000        1996454       Variance       1.30e+10
95%       100000        2200000       Skewness      -4.771637
99%       300000        2200000       Kurtosis       424.5165
. }

. 
. * CDs / T-bills
. capture confirm variable h16acd h15acd

. if _rc {
.     di as txt "WARNING: CD/T-bill variables (h16acd, h15acd) not found"
.     gen double cg_cd_2022 = .
. }

. else {
.     gen double cg_cd_2022 = h16acd - h15acd
(3,688 missing values generated)
.     di as txt "CD/T-bill capital gains summary:"
CD/T-bill capital gains summary:
.     summarize cg_cd_2022, detail

                         cg_cd_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -100000       -3000000
 5%        -2500       -1000000
10%            0       -1000000       Obs              12,168
25%            0        -700000       Sum of wgt.      12,168

50%            0                      Mean           1413.315
                        Largest       Std. dev.      66440.24
75%            0       798701.8
90%            0        1127046       Variance       4.41e+09
95%         3000        2000000       Skewness        7.66829
99%       140000        3500000       Kurtosis       1079.749
. }

. 
. * Vehicles
. capture confirm variable h16atran h15atran

. if _rc {
.     di as txt "WARNING: Vehicle variables (h16atran, h15atran) not found"
.     gen double cg_veh_2022 = .
. }

. else {
.     gen double cg_veh_2022 = h16atran - h15atran
(3,688 missing values generated)
.     di as txt "Vehicle capital gains summary:"
Vehicle capital gains summary:
.     summarize cg_veh_2022, detail

                         cg_veh_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%       -60000        -350000
 5%       -22000        -350000
10%       -12000      -249953.4       Obs              12,168
25%        -3000        -233544       Sum of wgt.      12,168

50%            0                      Mean           4036.507
                        Largest       Std. dev.      49994.72
75%         8000       748419.7
90%        23000         750000       Variance       2.50e+09
95%        35000        2880000       Skewness       43.85497
99%        90000        3460000       Kurtosis        2790.87
. }

. 
. * Other assets
. capture confirm variable h16aothr h15aothr

. if _rc {
.     di as txt "WARNING: Other asset variables (h16aothr, h15aothr) not found"
.     gen double cg_oth_2022 = .
. }

. else {
.     gen double cg_oth_2022 = h16aothr - h15aothr
(3,688 missing values generated)
.     di as txt "Other asset capital gains summary:"
Other asset capital gains summary:
.     summarize cg_oth_2022, detail

                         cg_oth_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -200000       -7433104
 5%       -15000       -5471017
10%            0       -4000000       Obs              12,168
25%            0       -3200000       Sum of wgt.      12,168

50%            0                      Mean          -385.0057
                        Largest       Std. dev.      162661.6
75%            0        2000000
90%            0        3963000       Variance       2.65e+10
95%        20000        3963000       Skewness      -8.882589
99%       250000        5995000       Kurtosis       775.7602
. }

. 
. * Total capital gains (sum non-missing components; set total to missing if ALL components 
> missing)
. capture drop cg_total_2022

. egen byte any_cg_2022 = rownonmiss(cg_res_2022 cg_res2_2022 cg_re_2022 cg_bus_2022 cg_ira_
> 2022 cg_stk_2022 cg_bnd_2022 cg_chk_2022 cg_cd_2022 cg_veh_2022 cg_oth_2022)

. gen double cg_total_2022 = .
(15,856 missing values generated)

. replace cg_total_2022 = cond(missing(cg_res_2022), 0, cg_res_2022) + ///
>                           cond(missing(cg_res2_2022), 0, cg_res2_2022) + ///
>                           cond(missing(cg_re_2022), 0, cg_re_2022) + ///
>                           cond(missing(cg_bus_2022), 0, cg_bus_2022) + ///
>                           cond(missing(cg_ira_2022), 0, cg_ira_2022) + ///
>                           cond(missing(cg_stk_2022), 0, cg_stk_2022) + ///
>                           cond(missing(cg_bnd_2022), 0, cg_bnd_2022) + ///
>                           cond(missing(cg_chk_2022), 0, cg_chk_2022) + ///
>                           cond(missing(cg_cd_2022), 0, cg_cd_2022) + ///
>                           cond(missing(cg_veh_2022), 0, cg_veh_2022) + ///
>                           cond(missing(cg_oth_2022), 0, cg_oth_2022) if any_cg_2022>0
(12,168 real changes made)

. drop any_cg_2022

. 
. * Use cg_total_2022 directly below with inline missing handling
. 
. di as txt "Total capital gains (cg_total_2022) summary:"
Total capital gains (cg_total_2022) summary:

. summarize cg_total_2022, detail

                        cg_total_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%     -1334000      -1.35e+07
 5%      -336897       -9243731
10%      -139700       -8299500       Obs              12,168
25%        -7000       -8230851       Sum of wgt.      12,168

50%        20000                      Mean           125624.5
                        Largest       Std. dev.      711506.2
75%       158000       1.22e+07
90%     498248.3       1.33e+07       Variance       5.06e+11
95%       913000       1.33e+07       Skewness       4.341353
99%      2253884       1.78e+07       Kurtosis       115.2076

. 
. * ---------------------------------------------------------------------
. * Variant: Exclude residential housing from numerator (keep denominator same)
. * - Remove primary and secondary residence components from CG and flows
. * - Follow same missing/zero rules as current calculation
. * ---------------------------------------------------------------------
. di as txt "=== Building EXCL-RESIDENTIAL components (numerator only) ==="
=== Building EXCL-RESIDENTIAL components (numerator only) ===

. 
. * Capital gains excluding residences: sum all non-residential components (treat missing as
>  zero)
. capture drop cg_total_2022_excl_res

. gen double cg_total_2022_excl_res = ///
>       cond(missing(cg_re_2022),   0, cg_re_2022)   + /// other real estate
>       cond(missing(cg_bus_2022),  0, cg_bus_2022)  + /// business
>       cond(missing(cg_ira_2022),  0, cg_ira_2022)  + /// ira/keogh
>       cond(missing(cg_stk_2022),  0, cg_stk_2022)  + /// stocks
>       cond(missing(cg_bnd_2022),  0, cg_bnd_2022)  + /// bonds
>       cond(missing(cg_chk_2022),  0, cg_chk_2022)  + /// checking/savings
>       cond(missing(cg_cd_2022),   0, cg_cd_2022)   + /// cds/t-bills
>       cond(missing(cg_veh_2022),  0, cg_veh_2022)  + /// vehicles
>       cond(missing(cg_oth_2022),  0, cg_oth_2022)    /// other assets
> 

. * Safe version (zero already when all components missing)
. capture drop cg_total_2022_excl_res_safe

. gen double cg_total_2022_excl_res_safe = cond(missing(cg_total_2022_excl_res), 0, cg_total
> _2022_excl_res)

. 
. * Flows excluding residences: sum non-residential asset-class flows
. * Requires component flows from long_merge_in.do
. capture drop flow_total_2022_excl_res

. gen double flow_total_2022_excl_res = .
(15,856 missing values generated)

. egen byte any_flow_present_nonres = rownonmiss(flow_bus_2022 flow_re_2022 flow_stk_2022 fl
> ow_ira_2022)

. replace flow_total_2022_excl_res = ///
>       cond(missing(flow_bus_2022),0,flow_bus_2022) + /// business
>       cond(missing(flow_re_2022), 0,flow_re_2022)  + /// other real estate
>       cond(missing(flow_stk_2022),0,flow_stk_2022) + /// stocks
>       cond(missing(flow_ira_2022),0,flow_ira_2022)   /// ira
>       if any_flow_present_nonres > 0
(2,561 real changes made)

. drop any_flow_present_nonres

. 
. * Safe version of non-residential flows
. capture drop flow_total_2022_excl_res_safe

. gen double flow_total_2022_excl_res_safe = cond(missing(flow_total_2022_excl_res), 0, flow
> _total_2022_excl_res)

. 
. di as txt "EXCL-RES: cg_total_2022_excl_res and flow_total_2022_excl_res summaries:"
EXCL-RES: cg_total_2022_excl_res and flow_total_2022_excl_res summaries:

. summarize cg_total_2022_excl_res flow_total_2022_excl_res

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
cg_total_2~s |     15,856    50782.55    584958.5  -1.33e+07   1.66e+07
flow_total~s |      2,561    36401.85    302128.4   -6400000    3534000

. 
. * ---------------------------------------------------------------------
. * Step 5: Compute debt payments (if needed)
. * ---------------------------------------------------------------------
. di as txt "=== Computing debt payments ==="
=== Computing debt payments ===

. 
. * For now, set debt payments to zero as they may not be needed in this formulation
. * This can be added later if specific debt payment variables are identified
. gen double debt_payments_2022 = 0

. 
. di as txt "Debt payments set to zero for now"
Debt payments set to zero for now

. 
. * ---------------------------------------------------------------------
. * Step 6: Compute period returns
. * ---------------------------------------------------------------------
. di as txt "=== Computing period returns ==="
=== Computing period returns ===

. 
. * Numerator: y^c_2022 + cg_total_2022 - flow_total_2022
. * - Treat missing components as 0 when present with others
. * - If ALL three are missing, set numerator to missing
. capture drop num_period

. gen double num_period = cond(missing(y_c_2022),0,y_c_2022) + ///
>                         cond(missing(cg_total_2022),0,cg_total_2022) - ///
>                         cond(missing(flow_total_2022),0,flow_total_2022)

. egen byte __num_has = rownonmiss(y_c_2022 cg_total_2022 flow_total_2022)

. replace num_period = . if __num_has == 0
(0 real changes made)

. drop __num_has

. 
. * Base: A_{2020} + 0.5 * F_total_period (treat missing flows as 0 only when A_2020 is non-
> missing)
. capture drop base

. gen double base = .
(15,856 missing values generated)

. replace base = a_2020 + 0.5 * cond(missing(flow_total_2022),0,flow_total_2022) if !missing
> (a_2020)
(12,168 real changes made)

. 
. * --- EXCLUDE RESIDENTIAL: compute returns using same base ---
. capture drop num_period_excl_res

. gen double num_period_excl_res = cond(missing(y_c_2022),0,y_c_2022) + ///
>                                  cond(missing(cg_total_2022_excl_res),0,cg_total_2022_excl
> _res) - ///
>                                  cond(missing(flow_total_2022_excl_res),0,flow_total_2022_
> excl_res)

. egen byte __num_has_ex = rownonmiss(y_c_2022 cg_total_2022_excl_res flow_total_2022_excl_r
> es)

. replace num_period_excl_res = . if __num_has_ex == 0
(0 real changes made)

. drop __num_has_ex

. 
. capture drop r_period_excl_res

. gen double r_period_excl_res = num_period_excl_res / base
(4,477 missing values generated)

. replace r_period_excl_res = . if base < 10000
(1,784 real changes made, 1,784 to missing)

. 
. di as txt "Period returns excl-res (r_period_excl_res) summary:"
Period returns excl-res (r_period_excl_res) summary:

. summarize r_period_excl_res, detail

                      r_period_excl_res
-------------------------------------------------------------
      Percentiles      Smallest
 1%           -1      -3.622496
 5%    -.6333333      -3.363636
10%    -.4132607      -3.363636       Obs               9,595
25%    -.1210938             -3       Sum of wgt.       9,595

50%     .0321782                      Mean           .3306158
                        Largest       Std. dev.      3.292939
75%      .292876         43.813
90%     .9109005       45.86047       Variance       10.84345
95%     1.672249       97.32017       Skewness       60.29991
99%      6.20016       268.7991       Kurtosis       4694.518

. 
. * Annualize excl-res
. capture drop r_annual_2022_excl_res

. gen double r_annual_2022_excl_res = (1 + r_period_excl_res)^(1/2) - 1
(6,335 missing values generated)

. replace r_annual_2022_excl_res = . if missing(r_period_excl_res)
(0 real changes made)

. 
. di as txt "Annual returns excl-res (r_annual_2022_excl_res) summary:"
Annual returns excl-res (r_annual_2022_excl_res) summary:

. summarize r_annual_2022_excl_res, detail

                   r_annual_2022_excl_res
-------------------------------------------------------------
      Percentiles      Smallest
 1%    -.7388835             -1
 5%     -.360774             -1
10%    -.2183454             -1       Obs               9,521
25%    -.0587644             -1       Sum of wgt.       9,521

50%     .0168475                      Mean           .0776679
                        Largest       Std. dev.      .4281628
75%     .1381134       5.694251
90%     .3833917        5.84547       Variance       .1833234
95%     .6372816       8.915653       Skewness       8.480762
99%     1.683311       15.42556       Kurtosis       214.6135

. 
. * 5% trimming excl-res
. capture drop r_annual_2022_excl_res_trim

. gen double r_annual_2022_excl_res_trim = r_annual_2022_excl_res
(6,335 missing values generated)

. quietly _pctile r_annual_2022_excl_res, p(5 95)

. scalar p5_ex = r(r1)

. scalar p95_ex = r(r2)

. replace r_annual_2022_excl_res_trim = . if r_annual_2022_excl_res < p5_ex | r_annual_2022_
> excl_res > p95_ex
(952 real changes made, 952 to missing)

. 
. di as txt "Trimmed returns excl-res (r_annual_2022_excl_res_trim) summary:"
Trimmed returns excl-res (r_annual_2022_excl_res_trim) summary:

. summarize r_annual_2022_excl_res_trim, detail

                 r_annual_2022_excl_res_trim
-------------------------------------------------------------
      Percentiles      Smallest
 1%    -.3184258       -.360774
 5%    -.2296633      -.3599357
10%    -.1590353       -.359743       Obs               8,569
25%    -.0449387      -.3596767       Sum of wgt.       8,569

50%     .0168475                      Mean           .0452949
                        Largest       Std. dev.      .1743649
75%     .1207004       .6347014
90%     .2774513        .636874       Variance       .0304031
95%     .4025949       .6372816       Skewness       .7075587
99%     .5666537       .6372816       Kurtosis       4.066704

. 
. * Period return: R_period = num_period / base
. gen double r_period = num_period / base
(4,477 missing values generated)

. 
. * Set to missing if base is below threshold 10,000
. replace r_period = . if base < 10000
(1,784 real changes made, 1,784 to missing)

. 
. di as txt "Period returns (r_period) summary:"
Period returns (r_period) summary:

. summarize r_period, detail

                          r_period
-------------------------------------------------------------
      Percentiles      Smallest
 1%    -1.086653      -8.192117
 5%    -.8287671      -8.192117
10%    -.5396446      -5.285358       Obs               9,595
25%    -.1515411      -2.993902       Sum of wgt.       9,595

50%     .2132391                      Mean           .6977719
                        Largest       Std. dev.       4.12553
75%     .6808559             57
90%     1.730769       73.76744       Variance          17.02
95%      3.07187       128.8929       Skewness       43.21777
99%     10.09333       294.5683       Kurtosis       2807.635

. 
. * Stage counts for sample attrition and component presence
. quietly count

. local n_total = r(N)

. quietly count if !missing(a_2020)

. local n_has_a = r(N)

. quietly count if !missing(base)

. local n_has_base = r(N)

. quietly count if base >= 0 & !missing(base)

. local n_base_nonneg = r(N)

. quietly count if base >= 10000 & !missing(base)

. local n_basepos = r(N)

. quietly count if !missing(r_period)

. local n_r = r(N)

. di as txt "Stage counts -> total=`n_total' | has A_2020=`n_has_a' | has base=`n_has_base' 
> | base>=0=`n_base_nonneg' | base>=10k=`n_basepos' | r_period non-missing=`n_r'"
Stage counts -> total=15856 | has A_2020=12168 | has base=12168 | base>=0=11398 | base>=10k=
> 9595 | r_period non-missing=9595

. 
. * Denominator diagnostics
. di as txt "Denominator (base) diagnostics:"
Denominator (base) diagnostics:

. di as txt "  A_2020 non-missing (potential denominators): `n_has_a'"
  A_2020 non-missing (potential denominators): 12168

. di as txt "  Base non-missing: `n_has_base'"
  Base non-missing: 12168

. di as txt "  Base >= 0: `n_base_nonneg'"
  Base >= 0: 11398

. di as txt "  Base >= 10,000: `n_basepos'"
  Base >= 10,000: 9595

. di as txt "  Base summary (all non-missing):"
  Base summary (all non-missing):

. summarize base if !missing(base), detail

                            base
-------------------------------------------------------------
      Percentiles      Smallest
 1%    -53027.51       -2442000
 5%        -2977       -1020000
10%            0       -1020000       Obs              12,168
25%        22000        -999400       Sum of wgt.      12,168

50%       187500                      Mean           576210.3
                        Largest       Std. dev.       1246289
75%       597081       2.60e+07
90%      1445500       2.60e+07       Variance       1.55e+12
95%      2418076       2.68e+07       Skewness       6.978212
99%      5910000       2.68e+07       Kurtosis       91.15192

. 
. * Diagnostics: which numerator components are present (non-missing pre-safe)
. gen byte has_yc   = !missing(y_c_2022)

. gen byte has_cg   = !missing(cg_total_2022)

. gen byte has_flow = !missing(flow_total_2022)

. egen byte num_comp_nonmiss = rownonmiss(y_c_2022 cg_total_2022 flow_total_2022)

. di as txt "Numerator components (pre-safe) presence counts among A_2020 non-missing:"
Numerator components (pre-safe) presence counts among A_2020 non-missing:

. quietly count if has_yc   == 1 & !missing(a_2020)

. di as txt "  y_c_2022 present: " r(N)
  y_c_2022 present: 12168

. quietly count if has_cg   == 1 & !missing(a_2020)

. di as txt "  cg_total_2022 present: " r(N)
  cg_total_2022 present: 12168

. quietly count if has_flow == 1 & !missing(a_2020)

. di as txt "  flow_total_2022 present: " r(N)
  flow_total_2022 present: 3885

. quietly count if num_comp_nonmiss == 0 & !missing(a_2020)

. di as txt "  none present (numerator will be 0 via safe): " r(N)
  none present (numerator will be 0 via safe): 0

. 
. * ---------------------------------------------------------------------
. * Step 7: Annualize returns
. * ---------------------------------------------------------------------
. di as txt "=== Annualizing returns ==="
=== Annualizing returns ===

. 
. * Annual return: r_annual = (1 + R_period)^(1/2) - 1
. gen double r_annual_2022 = (1 + r_period)^(1/2) - 1
(6,400 missing values generated)

. 
. * Set to missing if period return is missing
. replace r_annual_2022 = . if missing(r_period)
(0 real changes made)

. 
. di as txt "Annual returns (r_annual_2022) summary:"
Annual returns (r_annual_2022) summary:

. summarize r_annual_2022, detail

                        r_annual_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%           -1             -1
 5%    -.4873854             -1
10%    -.2920106             -1       Obs               9,456
25%    -.0670998             -1       Sum of wgt.       9,456

50%     .1055416                      Mean           .1781845
                        Largest       Std. dev.      .5839486
75%     .3004262       6.615773
90%     .6641006       7.646817       Variance       .3409959
95%     1.031901       10.39705       Skewness        5.35881
99%     2.346707        16.1921       Kurtosis       89.30955

. 
. * ---------------------------------------------------------------------
. * Step 8: Apply 5% trimming
. * ---------------------------------------------------------------------
. di as txt "=== Applying 5% trimming ==="
=== Applying 5% trimming ===

. 
. * Calculate trimming thresholds
. quietly _pctile r_annual_2022, p(5 95)

. scalar p5 = r(r1)

. scalar p95 = r(r2)

. 
. di as txt "5th percentile: " %12.4f p5
5th percentile:      -0.4874

. di as txt "95th percentile: " %12.4f p95
95th percentile:       1.0319

. 
. * Create trimmed returns
. gen double r_annual_2022_trimmed = r_annual_2022
(6,400 missing values generated)

. replace r_annual_2022_trimmed = . if r_annual_2022 < p5 | r_annual_2022 > p95
(943 real changes made, 943 to missing)

. 
. quietly count if !missing(r_annual_2022_trimmed)

. local n_trimmed = r(N)

. quietly count if !missing(r_annual_2022)

. local n_original = r(N)

. 
. di as txt "Original sample size: `n_original'"
Original sample size: 9456

. di as txt "Trimmed sample size: `n_trimmed'"
Trimmed sample size: 8513

. di as txt "Trimmed sample size: " %4.1f 100*`n_trimmed'/`n_original' "% of original"
Trimmed sample size: 90.0% of original

. 
. di as txt "Trimmed returns summary:"
Trimmed returns summary:

. summarize r_annual_2022_trimmed, detail

                    r_annual_2022_trimmed
-------------------------------------------------------------
      Percentiles      Smallest
 1%    -.4383383      -.4873854
 5%    -.3047782      -.4870108
10%    -.1997877      -.4858313       Obs               8,513
25%    -.0438171      -.4852498       Sum of wgt.       8,513

50%     .1055416                      Mean           .1322006
                        Largest       Std. dev.       .279529
75%     .2758148       1.024617
90%     .5018785       1.026992       Variance       .0781365
95%     .6841814       1.031901       Skewness       .5763808
99%     .9259471       1.031901       Kurtosis       3.520286

. 
. * ---------------------------------------------------------------------
. * Step 9: Simple N diagnostics (included vs excl-res)
. * ---------------------------------------------------------------------
. di as txt "=== N diagnostics (included and excl-res) ==="
=== N diagnostics (included and excl-res) ===

. quietly count if !missing(r_period)

. di as txt "  N r_period (included): " r(N)
  N r_period (included): 9595

. quietly count if !missing(r_annual_2022)

. di as txt "  N r_annual_2022 (included): " r(N)
  N r_annual_2022 (included): 9456

. quietly count if !missing(r_period_excl_res)

. di as txt "  N r_period_excl_res: " r(N)
  N r_period_excl_res: 9595

. quietly count if !missing(r_annual_2022_excl_res)

. di as txt "  N r_annual_2022_excl_res: " r(N)
  N r_annual_2022_excl_res: 9521

. 
. * ---------------------------------------------------------------------
. * Save results
. * ---------------------------------------------------------------------
. di as txt "=== Saving results ==="
=== Saving results ===

. 
. save "`output_file'", replace
file /Volumes/SSD
    PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_Long/randhrs1992_2022v1_STATA/_ran
    > dhrs1992_2022v1_analysis.dta saved

. di as txt "Saved results to: `output_file'"
Saved results to: /Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_Long/rand
> hrs1992_2022v1_STATA/_randhrs1992_2022v1_analysis.dta

. 
. quietly describe

. local n_vars_final = r(k)

. local n_obs_final = r(N)

. di as txt "Final file: `n_obs_final' observations, `n_vars_final' variables"
Final file: 15856 observations, 19943 variables

. 
. log close
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_Long/randhrs19
> 92_2022v1_STATA/compute_tot_ret_2022.log
  log type:  text
 closed on:   8 Oct 2025, 12:09:03
--------------------------------------------------------------------------------------------
