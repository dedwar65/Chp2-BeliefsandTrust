------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_Long/randhrs
> 1992_2022v1_STATA/long_merge_in.log
  log type:  text
 opened on:   3 Oct 2025, 10:39:20

. 
. set more off

. 
. * ---------------------------------------------------------------------
. * File paths
. * ---------------------------------------------------------------------
. local long_file "/Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_Long/r
> andhrs1992_2022v1_STATA/_randhrs1992_2022v1.dta"

. local raw_2022 "/Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_RAND/_r
> aw/2022/h22e3a_STATA/h22e3a.dta"

. local output_file "/Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_Long
> /randhrs1992_2022v1_STATA/_randhrs1992_2022v1_analysis.dta"

. 
. * ---------------------------------------------------------------------
. * Check if files exist
. * ---------------------------------------------------------------------
. di as txt "=== Checking file existence ==="
=== Checking file existence ===

. 
. capture confirm file "`long_file'"

. if _rc {
.     di as error "ERROR: Longitudinal file not found -> `long_file'"
.     exit 198
. }

. di as txt "OK: Longitudinal file found"
OK: Longitudinal file found

. 
. capture confirm file "`raw_2022'"

. if _rc {
.     di as error "ERROR: Raw 2022 file not found -> `raw_2022'"
.     exit 198
. }

. di as txt "OK: Raw 2022 file found"
OK: Raw 2022 file found

. 
. * ---------------------------------------------------------------------
. * Load longitudinal file
. * ---------------------------------------------------------------------
. di as txt "=== Loading longitudinal file ==="
=== Loading longitudinal file ===

. use "`long_file'", clear

. 
. di as txt "Longitudinal file loaded successfully"
Longitudinal file loaded successfully

. quietly describe

. local n_vars_long = r(k)

. local n_obs_long = r(N)

. di as txt "Variables in longitudinal file: `n_vars_long'"
Variables in longitudinal file: 19880

. di as txt "Observations in longitudinal file: `n_obs_long'"
Observations in longitudinal file: 45234

. 
. * Check for hhidpn
. capture confirm variable hhidpn

. if _rc {
.     di as error "ERROR: hhidpn not found in longitudinal file"
.     exit 198
. }

. di as txt "OK: hhidpn found in longitudinal file"
OK: hhidpn found in longitudinal file

. 
. * Check for duplicates in longitudinal file
. quietly duplicates report hhidpn

. local n_dups_long = r(unique_value)

. if `n_dups_long' != `n_obs_long' {
.     di as error "ERROR: Duplicate hhidpn found in longitudinal file"
.     di as error "Unique hhidpn: `n_dups_long', Total observations: `n_obs_long'"
.     exit 198
. }

. di as txt "OK: No duplicate hhidpn in longitudinal file"
OK: No duplicate hhidpn in longitudinal file

. 
. * ---------------------------------------------------------------------
. * Load raw 2022 file and extract needed variables
. * ---------------------------------------------------------------------
. di as txt "=== Loading raw 2022 file and extracting flow variables ==="
=== Loading raw 2022 file and extracting flow variables ===

. preserve

. use "`raw_2022'", clear

. 
. di as txt "Raw 2022 file loaded successfully"
Raw 2022 file loaded successfully

. quietly describe

. local n_vars_raw = r(k)

. local n_obs_raw = r(N)

. di as txt "Variables in raw 2022 file: `n_vars_raw'"
Variables in raw 2022 file: 7062

. di as txt "Observations in raw 2022 file: `n_obs_raw'"
Observations in raw 2022 file: 15856

. 
. * Check for hhidpn
. capture confirm variable hhidpn

. if _rc {
.     di as error "ERROR: hhidpn not found in raw 2022 file"
.     exit 198
. }

. di as txt "OK: hhidpn found in raw 2022 file"
OK: hhidpn found in raw 2022 file

. 
. * Check for flow variables
. local flow_vars "sr050 sr055 sr063 sr064 sr072 sr030 sr035 sr045 sq171_1 sq171_2 sq171_3
>  sr007 sr013 sr024"

. di as txt "Checking for flow variables..."
Checking for flow variables...

. foreach v of local flow_vars {
  2.     capture confirm variable `v'
  3.     if _rc {
  4.         di as txt "  WARNING: `v' not found in raw 2022 file"
  5.     }
  6.     else {
  7.         di as txt "  OK: `v' found"
  8.     }
  9. }
  OK: sr050 found
  OK: sr055 found
  OK: sr063 found
  OK: sr064 found
  OK: sr072 found
  OK: sr030 found
  OK: sr035 found
  OK: sr045 found
  OK: sq171_1 found
  OK: sq171_2 found
  OK: sq171_3 found
  OK: sr007 found
  OK: sr013 found
  OK: sr024 found

. 
. * Keep only hhidpn and flow variables
. keep hhidpn `flow_vars'

. 
. * Check for duplicates in raw file
. quietly duplicates report hhidpn

. local n_dups_raw = r(unique_value)

. if `n_dups_raw' != `n_obs_raw' {
.     di as error "ERROR: Duplicate hhidpn found in raw 2022 file"
.     di as error "Unique hhidpn: `n_dups_raw', Total observations: `n_obs_raw'"
.     di as error "The raw file should have unique hhidpn values (one per person)"
.     di as error "This indicates a problem with the raw file structure"
.     exit 198
. }

. else {
.     di as txt "OK: No duplicate hhidpn in raw 2022 file"
OK: No duplicate hhidpn in raw 2022 file
. }

. 
. * Save temporary file
. tempfile raw_flows

. save "`raw_flows'", replace
(file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_01891.000005 not found)
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_01891.000005 saved as .dta
    format

. restore

. 
. * ---------------------------------------------------------------------
. * Merge flow variables into longitudinal data
. * ---------------------------------------------------------------------
. di as txt "=== Merging flow variables into longitudinal data ==="
=== Merging flow variables into longitudinal data ===

. 
. merge 1:1 hhidpn using "`raw_flows'"

    Result                      Number of obs
    -----------------------------------------
    Not matched                        29,378
        from master                    29,378  (_merge==1)
        from using                          0  (_merge==2)

    Matched                            15,856  (_merge==3)
    -----------------------------------------

. 
. * Report merge results
. di as txt "Merge results:"
Merge results:

. tab _merge

   Matching result from |
                  merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        Master only (1) |     29,378       64.95       64.95
            Matched (3) |     15,856       35.05      100.00
------------------------+-----------------------------------
                  Total |     45,234      100.00

. 
. quietly count if _merge == 3

. local n_matched = r(N)

. quietly count if _merge == 1

. local n_long_only = r(N)

. quietly count if _merge == 2

. local n_raw_only = r(N)

. 
. di as txt "Matched observations: `n_matched'"
Matched observations: 15856

. di as txt "Longitudinal only: `n_long_only'"
Longitudinal only: 29378

. di as txt "Raw 2022 only: `n_raw_only'"
Raw 2022 only: 0

. 
. * Keep only matched observations
. keep if _merge == 3
(29,378 observations deleted)

. drop _merge

. 
. di as txt "Kept `n_matched' matched observations"
Kept 15856 matched observations

. 
. * ---------------------------------------------------------------------
. * Compute flow_total_2022 from individual flow variables
. * ---------------------------------------------------------------------
. di as txt "=== Computing flow_total_2022 from individual flow variables ==="
=== Computing flow_total_2022 from individual flow variables ===

. 
. * Clean missing value codes
. local misscodes 999998 999999 9999999 9999998 99999998 99999999 999999999 999999998 9999
> 999999 9999999998 -8 -9

. foreach v of local flow_vars {
  2.     capture confirm numeric variable `v'
  3.     if !_rc {
  4.         foreach mc of local misscodes {
  5.             quietly replace `v' = . if `v' == `mc'
  6.         }
  7.     }
  8. }

. 
. * Flows - EXACT COPY FROM HRS_RAND VERSION
. 
. * Clean sr063 and create direction variable
. capture confirm variable sr063

. if _rc {
.     di as txt "sr063 not found; skipping sr063 cleaning/mapping."
. }

. else {
.     di as txt "Cleaning sr063 (private stock net buyer/seller)..."
Cleaning sr063 (private stock net buyer/seller)...
.     quietly replace sr063 = . if inlist(sr063,8,9)
.     quietly replace sr063 = 0 if sr063 == 3
.     capture drop sr063_dir
.     gen byte sr063_dir = . 
(15,856 missing values generated)
.     replace sr063_dir = -1 if sr063 == 1
(123 real changes made)
.     replace sr063_dir =  1 if sr063 == 2
(100 real changes made)
.     replace sr063_dir =  0 if sr063 == 3
(0 real changes made)
. }

. 
. * --- Private business: sr055 (sell/inflow) minus sr050 (invest/outflow)
. capture drop flow_bus_2022

. gen double flow_bus_2022 = .
(15,856 missing values generated)

. * both present -> net
. replace flow_bus_2022 = sr055 - sr050 if !missing(sr055) & !missing(sr050)
(3 real changes made)

. * sell only -> positive inflow
. replace flow_bus_2022 = sr055 if  missing(sr050) & !missing(sr055)
(30 real changes made)

. * buy only -> negative outflow
. replace flow_bus_2022 = -sr050 if !missing(sr050) &  missing(sr055)
(114 real changes made)

. 
. * --- Private stocks: sr063_dir * sr064
. capture confirm variable sr064

. if _rc {
.     di as txt "sr064 (stock magnitude) missing -> setting flow_stk_private_2022 to missi
> ng"
.     gen double flow_stk_private_2022 = .
. }

. else {
.     capture drop flow_stk_private_2022
.     gen double flow_stk_private_2022 = .
(15,856 missing values generated)
.     replace flow_stk_private_2022 = sr063_dir * sr064 if !missing(sr063_dir) & !missing(
> sr064)
(173 real changes made)
. }

. 
. * --- Public stocks: sr073 is reported as sold amount (inflow). Keep positive.
. capture confirm variable sr073

. if _rc {
.     di as txt "sr073 not found -> flow_stk_public_2022 missing"
sr073 not found -> flow_stk_public_2022 missing
.     gen double flow_stk_public_2022 = .
(15,856 missing values generated)
. }

. else {
.     capture drop flow_stk_public_2022
.     gen double flow_stk_public_2022 = sr073
. }

. 
. * Combine private + public stocks into total stocks flow
. capture drop flow_stk_2022

. gen double flow_stk_2022 = cond(!missing(flow_stk_private_2022), flow_stk_private_2022, 
> 0) + ///
>                             cond(!missing(flow_stk_public_2022),  flow_stk_public_2022, 
>  0)

. replace flow_stk_2022 = . if missing(flow_stk_private_2022) & missing(flow_stk_public_20
> 22)
(15,683 real changes made, 15,683 to missing)

. 
. * --- Real estate: sr035 (sold, inflow) - sr030 (buy, outflow) - sr045 (improvement cost
> s, outflow)
. capture drop flow_re_2022

. gen double flow_re_2022 = .
(15,856 missing values generated)

. replace flow_re_2022 = cond(missing(sr035),0,sr035) - ( cond(missing(sr030),0,sr030) + c
> ond(missing(sr045),0,sr045) ) if !missing(sr035) | !missing(sr030) | !missing(sr045)
(416 real changes made)

. 
. * --- IRA: sum sq171_1 sq171_2 sq171_3 (kept as reported)
. capture drop flow_ira_2022

. egen double flow_ira_2022 = rowtotal(sq171_1 sq171_2 sq171_3)

. * Set to missing if ALL three components are missing
. replace flow_ira_2022 = . if missing(sq171_1) & missing(sq171_2) & missing(sq171_3)
(13,953 real changes made, 13,953 to missing)

. 
. * --- Primary/secondary residence(s): sr013 (sell, inflow) - sr007 (buy, outflow) - sr02
> 4 (improvements, outflow)
. capture drop flow_residences_2022

. gen double flow_residences_2022 = .
(15,856 missing values generated)

. replace flow_residences_2022 = cond(missing(sr013),0,sr013) - ( cond(missing(sr007),0,sr
> 007) + cond(missing(sr024),0,sr024) ) if !missing(sr013) | !missing(sr007) | !missing(sr
> 024)
(2,460 real changes made)

. 
. * Ensure missing only when all three residence components are missing
. replace flow_residences_2022 = . if missing(sr013) & missing(sr007) & missing(sr024)
(0 real changes made)

. 
. * Total net investment flows for 2022
. * Missing only if ALL asset class flows are missing
. * Otherwise, sum non-missing flows (treat missing as zero)
. capture drop flow_total_2022

. gen double flow_total_2022 = .
(15,856 missing values generated)

. * Check if at least one asset class has non-missing flow
. egen byte any_flow_present = rownonmiss(flow_bus_2022 flow_re_2022 flow_stk_2022 flow_ir
> a_2022 flow_residences_2022)

. * Compute total only if at least one flow is present
. replace flow_total_2022 = cond(missing(flow_bus_2022),0,flow_bus_2022) + ///
>                          cond(missing(flow_re_2022),0,flow_re_2022) + ///
>                          cond(missing(flow_stk_2022),0,flow_stk_2022) + ///
>                          cond(missing(flow_ira_2022),0,flow_ira_2022) + ///
>                          cond(missing(flow_residences_2022),0,flow_residences_2022) ///
>                          if any_flow_present > 0
(4,163 real changes made)

. drop any_flow_present

. 
. di as txt "flow_total_2022 computed successfully"
flow_total_2022 computed successfully

. summarize flow_total_2022, detail

                       flow_total_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -650000       -6400000
 5%      -211000       -6400000
10%       -94000       -2660000       Obs               4,163
25%       -20000       -2660000       Sum of wgt.       4,163

50%          100                      Mean            10238.2
                        Largest       Std. dev.      281541.3
75%        25000        3450000
90%       132119        3474000       Variance       7.93e+10
95%       273000        3474000       Skewness       -3.44539
99%       800000        3500000       Kurtosis       169.6066

. 
. * ---------------------------------------------------------------------
. * Save results
. * ---------------------------------------------------------------------
. di as txt "=== Saving results ==="
=== Saving results ===

. 
. save "`output_file'", replace
file /Volumes/SSD
    PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_Long/randhrs1992_2022v1_STATA/_r
    > andhrs1992_2022v1_analysis.dta saved

. di as txt "Saved merged file to: `output_file'"
Saved merged file to: /Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_Lon
> g/randhrs1992_2022v1_STATA/_randhrs1992_2022v1_analysis.dta

. 
. quietly describe

. local n_vars_final = r(k)

. local n_obs_final = r(N)

. di as txt "Final file: `n_obs_final' observations, `n_vars_final' variables"
Final file: 15856 observations, 19903 variables

. 
. * ---------------------------------------------------------------------
. * Summary
. * ---------------------------------------------------------------------
. di as txt "=== Merge Summary ==="
=== Merge Summary ===

. di as txt "Original longitudinal observations: `n_obs_long'"
Original longitudinal observations: 45234

. di as txt "Raw 2022 observations: `n_obs_raw'"
Raw 2022 observations: 15856

. di as txt "Successfully matched: `n_matched'"
Successfully matched: 15856

. di as txt "Final merged file: `n_obs_final' observations, `n_vars_final' variables"
Final merged file: 15856 observations, 19903 variables

. 
. quietly count if !missing(flow_total_2022)

. local n_with_flows = r(N)

. di as txt "Observations with flow_total_2022: `n_with_flows'"
Observations with flow_total_2022: 4163

. 
. log close
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_Long/randhrs
> 1992_2022v1_STATA/long_merge_in.log
  log type:  text
 closed on:   3 Oct 2025, 10:39:29
------------------------------------------------------------------------------------------
