----------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_RAND/cleaned/com
> pute_net_flows_2022.log
  log type:  text
 opened on:  25 Sep 2025, 09:45:13

. 
. set more off

. 
. local master "/Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_RAND/cleaned/
> hrs_rand_2020_2022_master.dta"

. capture confirm file "`master'"

. if _rc {
.     di as error "ERROR: master file not found -> `master'"
.     exit 198
. }

. 
. use "`master'", clear

. 
. di as txt "Using master file: `master'"
Using master file: /Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_RAND/clean
> ed/hrs_rand_2020_2022_master.dta

. 
. * ---------------------------------------------------------------------
. * Optional: convert common special codes to Stata missing (numeric variables)
. * ---------------------------------------------------------------------
. local misscodes 999999998 999999999 -8 -9

. foreach v of varlist _all {
  2.     capture confirm numeric variable `v'
  3.     if !_rc {
  4.         foreach mc of local misscodes {
  5.             quietly replace `v' = . if `v' == `mc'
  6.         }
  7.     }
  8. }

. 
. * ---------------------------------------------------------------------
. * Variables (2022)
. * - private business: SR050 (invest), SR055 (sell)
. * - stocks (private): SR063 (direction), SR064 (magnitude)
. *   - public stocks (sold only): SR073 (sold)
. * - real estate: SR030 (buy), SR035 (sold), SR045 (improvement costs)
. * - IRA: SQ171_1, SQ171_2, SQ171_3
. * - primary/secondary residence(s): SR007 (buy), SR013 (sell), SR024 (improvement costs)
. * ---------------------------------------------------------------------
. 
. local vars_to_check "sr050 sr055 sr063 sr064 sr073 sr030 sr035 sr045 sq171_1 sq171_2 sq171_3
>  sr007 sr013 sr024"

. di as txt "Checking existence of required 2022 variables..."
Checking existence of required 2022 variables...

. foreach v of local vars_to_check {
  2.     capture confirm variable `v'
  3.     if _rc {
  4.         di as err "  WARNING: variable `v' not found in master dataset"
  5.     }
  6.     else {
  7.         di as txt "  OK: `v' present"
  8.     }
  9. }
  OK: sr050 present
  OK: sr055 present
  OK: sr063 present
  OK: sr064 present
  OK: sr073 present
  OK: sr030 present
  OK: sr035 present
  OK: sr045 present
  OK: sq171_1 present
  OK: sq171_2 present
  OK: sq171_3 present
  OK: sr007 present
  OK: sr013 present
  OK: sr024 present

. 
. * Clean sr063
. capture confirm variable sr063

. if _rc {
.     di as txt "sr063 not found; skipping sr063 cleaning/mapping."
. }

. else {
.     di as txt "Cleaning sr063 (private stock net buyer/seller)..."
Cleaning sr063 (private stock net buyer/seller)...
.     quietly replace sr063 = . if inlist(sr063,8,9)
.     quietly replace sr063 = 0 if sr063 == 3
.     capture drop sr063_dir
.     gen byte sr063_dir = . 
(14,442 missing values generated)
.     replace sr063_dir = -1 if sr063 == 1
(79 real changes made)
.     replace sr063_dir =  1 if sr063 == 2
(69 real changes made)
.     replace sr063_dir =  0 if sr063 == 3
(0 real changes made)
.     di as txt "sr063 mapping summary (post-clean):"
sr063 mapping summary (post-clean):
.     tab sr063, missing

  r put new |
  amt in or |
   take out |
     stocks |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        107        0.74        0.74
          1 |         79        0.55        1.29
          2 |         69        0.48        1.77
          . |     14,187       98.23      100.00
------------+-----------------------------------
      Total |     14,442      100.00
.     di as txt "sr063_dir summary:"
sr063_dir summary:
.     tab sr063_dir, missing

  sr063_dir |      Freq.     Percent        Cum.
------------+-----------------------------------
         -1 |         79        0.55        0.55
          1 |         69        0.48        1.02
          . |     14,294       98.98      100.00
------------+-----------------------------------
      Total |     14,442      100.00
. }

. 
. * Flows
. * --- Private business: sr055 (sell/inflow) minus sr050 (invest/outflow)
. capture drop flow_bus_2022

. gen double flow_bus_2022 = .
(14,442 missing values generated)

. * both present -> net
. replace flow_bus_2022 = sr055 - sr050 if !missing(sr055) & !missing(sr050)
(3 real changes made)

. * sell only -> positive inflow
. replace flow_bus_2022 = sr055 if  missing(sr050) & !missing(sr055)
(17 real changes made)

. * buy only -> negative outflow
. replace flow_bus_2022 = -sr050 if !missing(sr050) &  missing(sr055)
(80 real changes made)

. di as txt "Private business flow summary:"
Private business flow summary:

. summarize flow_bus_2022, detail

                        flow_bus_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%     -1000000       -1000000
 5%      -195000       -1000000
10%      -100000        -300000       Obs                 100
25%       -25000        -200000       Sum of wgt.         100

50%        -5000                      Mean            51412.5
                        Largest       Std. dev.      499773.3
75%         -650         685670
90%       112500        1450000       Variance       2.50e+11
95%       248000        2750000       Skewness       4.977627
99%      3125000        3500000       Kurtosis       32.86307

. 
. * --- Private stocks: sr063_dir * sr064
. capture confirm variable sr064

. if _rc {
.     di as txt "sr064 (stock magnitude) missing -> setting flow_stk_private_2022 to missing"
.     gen double flow_stk_private_2022 = .
. }

. else {
.     capture drop flow_stk_private_2022
.     gen double flow_stk_private_2022 = .
(14,442 missing values generated)
.     replace flow_stk_private_2022 = sr063_dir * sr064 if !missing(sr063_dir) & !missing(sr06
> 4)
(116 real changes made)
.     di as txt "Private stock flow summary (sr063_dir * sr064):"
Private stock flow summary (sr063_dir * sr064):
.     summarize flow_stk_private_2022, detail

                    flow_stk_private_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -300000       -2000000
 5%      -200000        -300000
10%      -100000        -300000       Obs                 116
25%       -20000        -250000       Sum of wgt.         116

50%          -50                      Mean           10070.69
                        Largest       Std. dev.      266721.3
75%        40400         300000
90%       100000         500000       Variance       7.11e+10
95%       250000         600000       Skewness      -1.752954
99%       600000        1600000       Kurtosis       39.77505
. }

. 
. * --- Public stocks: sr073 is reported as sold amount (inflow). Keep positive.
. capture confirm variable sr073

. if _rc {
.     di as txt "sr073 not found -> flow_stk_public_2022 missing"
.     gen double flow_stk_public_2022 = .
. }

. else {
.     capture drop flow_stk_public_2022
.     gen double flow_stk_public_2022 = sr073
(14,280 missing values generated)
.     di as txt "Public stock (sold) flow summary (sr073):"
Public stock (sold) flow summary (sr073):
.     summarize flow_stk_public_2022, detail

                    flow_stk_public_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%          500              0
10%         2000              0       Obs                 162
25%         8000              0       Sum of wgt.         162

50%        24000                      Mean           69615.31
                        Largest       Std. dev.      131052.2
75%        75000         600000
90%       200000         600000       Variance       1.72e+10
95%       300000         730000       Skewness       4.125808
99%       730000        1000000       Kurtosis        23.8836
. }

. 
. * Combine private + public stocks into total stocks flow
. capture drop flow_stk_2022

. gen double flow_stk_2022 = cond(!missing(flow_stk_private_2022), flow_stk_private_2022, 0) +
>  ///
>                             cond(!missing(flow_stk_public_2022),  flow_stk_public_2022,  0)

. replace flow_stk_2022 = . if missing(flow_stk_private_2022) & missing(flow_stk_public_2022)
(14,164 real changes made, 14,164 to missing)

. di as txt "TOTAL stocks flow (2022) summary (missing when both components missing):"
TOTAL stocks flow (2022) summary (missing when both components missing):

. summarize flow_stk_2022, detail

                        flow_stk_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -300000       -2000000
 5%       -80000        -300000
10%       -20000        -300000       Obs                 278
25%          600        -250000       Sum of wgt.         278

50%        15000                      Mean           44769.36
                        Largest       Std. dev.      200953.7
75%        54000         600000
90%       180000         730000       Variance       4.04e+10
95%       300000        1000000       Skewness      -1.321848
99%       730000        1600000       Kurtosis       55.15205

. 
. * Quick check: households with BOTH public (sr073) and private magnitude (sr064) present
. di as txt "Checking overlap: sr073 (public sells) AND sr064 (private magnitude) both non-mis
> sing"
Checking overlap: sr073 (public sells) AND sr064 (private magnitude) both non-missing

. quietly count if !missing(sr073) & !missing(sr064)

. di as txt "Count with sr073 & sr064 both present = " r(N)
Count with sr073 & sr064 both present = 0

. quietly list hhid rsubhh sr073 sr064 flow_stk_public_2022 flow_stk_private_2022 in 1/10 if !
> missing(sr073) & !missing(sr064)

. 
. * --- Real estate: sr035 (sold, inflow) - sr030 (buy, outflow) - sr045 (improvement costs, o
> utflow)
. capture drop flow_re_2022

. gen double flow_re_2022 = .
(14,442 missing values generated)

. replace flow_re_2022 = cond(missing(sr035),0,sr035) - ( cond(missing(sr030),0,sr030) + cond(
> missing(sr045),0,sr045) ) if !missing(sr035) | !missing(sr030) | !missing(sr045)
(269 real changes made)

. di as txt "Real estate flow summary:"
Real estate flow summary:

. summarize flow_re_2022, detail

                        flow_re_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%     -1200000       -6400000
 5%      -515000       -1500000
10%      -290000       -1200000       Obs                 269
25%       -65000       -1040000       Sum of wgt.         269

50%       -10000                      Mean           3765.331
                        Largest       Std. dev.      573666.2
75%        85000        1700000
90%       240000        1750000       Variance       3.29e+11
95%       550000        2170000       Skewness      -3.974137
99%      1750000        3500000       Kurtosis       65.44258

. 
. * Overlap diagnostics for real estate raw components (buy/sell/improvements)
. gen byte ok_buy  = !missing(sr030)

. gen byte ok_sell = !missing(sr035)

. gen byte ok_impr = !missing(sr045)

. gen byte re_pattern = ok_sell*4 + ok_buy*2 + ok_impr

. label define rePat 0 "none" 1 "impr only" 2 "buy only" 3 "buy+impr" 4 "sell only" 5 "sell+im
> pr" 6 "sell+buy" 7 "sell+buy+impr"

. label values re_pattern rePat

. di as txt "Counts of buy/sell/improvements presence patterns (real estate):"
Counts of buy/sell/improvements presence patterns (real estate):

. tab re_pattern, missing

   re_pattern |      Freq.     Percent        Cum.
--------------+-----------------------------------
         none |     14,173       98.14       98.14
    impr only |         75        0.52       98.66
     buy only |         63        0.44       99.09
     buy+impr |         16        0.11       99.20
    sell only |        100        0.69       99.90
    sell+impr |         15        0.10      100.00
--------------+-----------------------------------
        Total |     14,442      100.00

. quietly count if ok_sell & ok_buy & ok_impr

. di as txt "Households with ALL THREE present = " r(N)
Households with ALL THREE present = 0

. 
. * --- IRA: sum sq171_1 sq171_2 sq171_3 (kept as reported)
. capture drop flow_ira_2022

. egen double flow_ira_2022 = rowtotal(sq171_1 sq171_2 sq171_3)

. * Set to missing if ALL three components are missing
. replace flow_ira_2022 = . if missing(sq171_1) & missing(sq171_2) & missing(sq171_3)
(13,154 real changes made, 13,154 to missing)

. di as txt "IRA flow summary (row-sum of sq171_1/2/3; missing when all three missing):"
IRA flow summary (row-sum of sq171_1/2/3; missing when all three missing):

. summarize flow_ira_2022, detail

                        flow_ira_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%          600              0
10%         1200              0       Obs               1,288
25%         4000              0       Sum of wgt.       1,288

50%        14000                      Mean           33867.53
                        Largest       Std. dev.      66722.69
75%        37218         500000
90%        82000         700000       Variance       4.45e+09
95%       120000         895000       Skewness       7.119528
99%       300000        1060000       Kurtosis       81.95964

. tabstat flow_ira_2022, stats(n mean sd p50 min max) format(%12.2f)

    Variable |            N         Mean           SD          p50          Min          Max
-------------+------------------------------------------------------------------------------
flow_ir~2022 |      1288.00     33867.53     66722.69     14000.00         0.00   1060000.00
--------------------------------------------------------------------------------------------

. 
. * Overlap diagnostics for IRA components
. gen byte ok_ira1 = !missing(sq171_1)

. gen byte ok_ira2 = !missing(sq171_2)

. gen byte ok_ira3 = !missing(sq171_3)

. gen byte ira_pattern = ok_ira1*4 + ok_ira2*2 + ok_ira3

. label define iraPat 0 "none" 1 "3 only" 2 "2 only" 3 "2+3" 4 "1 only" 5 "1+3" 6 "1+2" 7 "1+2
> +3"

. label values ira_pattern iraPat

. di as txt "Counts of presence patterns for IRA components (sq171_1/2/3):"
Counts of presence patterns for IRA components (sq171_1/2/3):

. tab ira_pattern, missing

ira_pattern |      Freq.     Percent        Cum.
------------+-----------------------------------
       none |     13,154       91.08       91.08
     3 only |         30        0.21       91.29
     2 only |        105        0.73       92.02
        2+3 |         17        0.12       92.13
     1 only |        827        5.73       97.86
        1+3 |         33        0.23       98.09
        1+2 |        206        1.43       99.52
      1+2+3 |         70        0.48      100.00
------------+-----------------------------------
      Total |     14,442      100.00

. 
. * --- Primary/secondary residence(s): sr013 (sell, inflow) - sr007 (buy, outflow) - sr024 (i
> mprovements, outflow)
. capture drop flow_residences_2022

. gen double flow_residences_2022 = .
(14,442 missing values generated)

. replace flow_residences_2022 = cond(missing(sr013),0,sr013) - ( cond(missing(sr007),0,sr007)
>  + cond(missing(sr024),0,sr024) ) if !missing(sr013) | !missing(sr007) | !missing(sr024)
(1,684 real changes made)

. di as txt "Primary/secondary residences flow summary:"
Primary/secondary residences flow summary:

. summarize flow_residences_2022, detail

                    flow_residences_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -600000       -2660000
 5%      -250000       -2050000
10%      -130000       -1600000       Obs               1,684
25%       -40000       -1003000       Sum of wgt.       1,684

50%       -15000                      Mean          -5964.808
                        Largest       Std. dev.      223486.3
75%        -3000        1100000
90%       150000        1225000       Variance       4.99e+10
95%       312000        2000000       Skewness       1.574816
99%       735000        3500000       Kurtosis         62.882

. 
. * Ensure missing only when all three residence components are missing
. replace flow_residences_2022 = . if missing(sr013) & missing(sr007) & missing(sr024)
(0 real changes made)

. 
. * Overlap diagnostics for residence components (buy/sell/improvements)
. gen byte ok_res_buy  = !missing(sr007)

. gen byte ok_res_sell = !missing(sr013)

. gen byte ok_res_impr = !missing(sr024)

. gen byte res_pattern = ok_res_sell*4 + ok_res_buy*2 + ok_res_impr

. label define resPat 0 "none" 1 "impr only" 2 "buy only" 3 "buy+impr" 4 "sell only" 5 "sell+i
> mpr" 6 "sell+buy" 7 "sell+buy+impr", replace

. label values res_pattern resPat

. di as txt "Counts of presence patterns for residence components (sr007/sr013/sr024):"
Counts of presence patterns for residence components (sr007/sr013/sr024):

. tab res_pattern, missing

  res_pattern |      Freq.     Percent        Cum.
--------------+-----------------------------------
         none |     12,758       88.34       88.34
    impr only |      1,142        7.91       96.25
     buy only |         87        0.60       96.85
     buy+impr |         38        0.26       97.11
    sell only |        162        1.12       98.23
    sell+impr |         53        0.37       98.60
     sell+buy |        114        0.79       99.39
sell+buy+impr |         88        0.61      100.00
--------------+-----------------------------------
        Total |     14,442      100.00

. quietly count if ok_res_sell & ok_res_buy & ok_res_impr

. di as txt "Households with ALL THREE residence components present = " r(N)
Households with ALL THREE residence components present = 88

. * ---------------------------------------------------------------------
. * Total net investment flows for 2022
. * Missing only if ALL asset class flows are missing
. * Otherwise, sum non-missing flows (treat missing as zero)
. * ---------------------------------------------------------------------
. capture drop flow_total_2022

. gen double flow_total_2022 = .
(14,442 missing values generated)

. * Check if at least one asset class has non-missing flow
. egen byte any_flow_present = rownonmiss(flow_bus_2022 flow_re_2022 flow_stk_2022 flow_ira_20
> 22 flow_residences_2022)

. * Compute total only if at least one flow is present
. replace flow_total_2022 = cond(missing(flow_bus_2022),0,flow_bus_2022) + ///
>                          cond(missing(flow_re_2022),0,flow_re_2022) + ///
>                          cond(missing(flow_stk_2022),0,flow_stk_2022) + ///
>                          cond(missing(flow_ira_2022),0,flow_ira_2022) + ///
>                          cond(missing(flow_residences_2022),0,flow_residences_2022) ///
>                          if any_flow_present > 0
(2,901 real changes made)

. drop any_flow_present

. 
. di as txt "Total net investment flows (flow_total_2022) summary:"
Total net investment flows (flow_total_2022) summary:

. summarize flow_total_2022, detail

                       flow_total_2022
-------------------------------------------------------------
      Percentiles      Smallest
 1%      -598400       -6400000
 5%      -190000       -2660000
10%       -75000       -2050000       Obs               2,901
25%       -19500       -1840000       Sum of wgt.       2,901

50%          750                      Mean           17985.74
                        Largest       Std. dev.      269453.3
75%        27000        2862500
90%       142230        3450000       Variance       7.26e+10
95%       296000        3474000       Skewness      -1.940754
99%       800000        3500000       Kurtosis       157.8651

. quietly count if !missing(flow_total_2022)

. di as txt "Records with flow_total_2022 computed = " r(N)
Records with flow_total_2022 computed = 2901

. 
. * ---------------------------------------------------------------------
. * Diagnostics...
. * ---------------------------------------------------------------------
. * (Generic diagnostics removed)
. 
. save "`master'", replace
file /Volumes/SSD
    PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_RAND/cleaned/hrs_rand_2020_2022_mast
    > er.dta saved

. di as txt "Saved 2022 net-flow vars back to master: `master'"
Saved 2022 net-flow vars back to master: /Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Co
> de/Data/HRS_RAND/cleaned/hrs_rand_2020_2022_master.dta

. 
. log close
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp2-BeliefsandTrust/Code/Data/HRS_RAND/cleaned/com
> pute_net_flows_2022.log
  log type:  text
 closed on:  25 Sep 2025, 09:45:13
----------------------------------------------------------------------------------------------
